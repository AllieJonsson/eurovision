<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              main: '#111827',
            },
          },
        },
      };
    </script>
    <script>
      const entries = [
        {
          country: 'Sverige',
          song: 'Bara bada bastu',
          artist: 'KAJ',
          id: 1,
          code: 'se',
        },
        {
          country: 'Israel',
          song: 'New Day Will Rise',
          artist: 'Yuval Raphael',
          id: 2,
          code: 'il',
        },
        {
          country: 'Nederländerna',
          song: 'C’est la vie',
          artist: 'Claude',
          id: 3,
          code: 'nl',
        },
        {
          country: 'San Marino',
          song: 'Tutta l’Italia',
          artist: 'Gabry Ponte',
          id: 4,
          code: 'sm',
        },
        {
          country: 'Spanien',
          song: 'Esa diva',
          artist: 'Melody',
          id: 5,
          code: 'es',
        },
        {
          country: 'Slovenien',
          song: 'How Much Time Do We Have Left',
          artist: 'Klemen',
          id: 6,
          code: 'si',
        },
        {
          country: 'Tyskland',
          song: 'Baller',
          artist: 'Abor & Tynna',
          id: 7,
          code: 'de',
        },
        {
          country: 'Luxemburg',
          song: 'La poupée monte le son',
          artist: 'Laura Thorn',
          id: 8,
          code: 'lu',
        },
        {
          country: 'Storbritannien',
          song: 'What The Hell Just Happened?',
          artist: 'Remember Monday',
          id: 9,
          code: 'gb',
        },
        {
          country: 'Frankrike',
          song: 'Maman',
          artist: 'Louane',
          id: 10,
          code: 'fr',
        },
        {
          country: 'Cypern',
          song: 'Shh',
          artist: 'Theo Evan',
          id: 11,
          code: 'cy',
        },
        {
          country: 'Armenien',
          song: 'Survivor',
          artist: 'Parg',
          id: 12,
          code: 'am',
        },
        {
          country: 'Serbien',
          song: 'Mila',
          artist: 'Princ',
          id: 13,
          code: 'rs',
        },
        {
          country: 'Norge',
          song: 'Lighter',
          artist: 'Kyle Alessandro',
          id: 14,
          code: 'no',
        },
        {
          country: 'Schweiz',
          song: 'Voyage',
          artist: 'Zoë Më',
          id: 15,
          code: 'ch',
        },
        {
          country: 'Österrike',
          song: 'Wasted Love',
          artist: 'JJ',
          id: 16,
          code: 'at',
        },
        {
          country: 'Irland',
          song: 'Laika Party',
          artist: 'Emmy',
          id: 17,
          code: 'ie',
        },
        {
          country: 'Litauen',
          song: 'Tavo akys',
          artist: 'Katarsis',
          id: 18,
          code: 'lt',
        },
        {
          country: 'Grekland',
          song: 'Asteromáta',
          artist: 'Klavdia',
          id: 19,
          code: 'gr',
        },
        {
          country: 'Danmark',
          song: 'Hallucination',
          artist: 'Sissal',
          id: 20,
          code: 'dk',
        },
        {
          country: 'Italien',
          song: 'Volevo essere un duro',
          artist: 'Lucio Corsi',
          id: 21,
          code: 'it',
        },
        {
          country: 'Finland',
          song: 'Ich komme',
          artist: 'Erika Vikman',
          id: 22,
          code: 'fi',
        },
        {
          country: 'Belgien',
          song: 'Strobe Lights',
          artist: 'Red Sebastian',
          id: 23,
          code: 'be',
        },
        {
          country: 'Montenegro',
          song: 'Dobrodošli',
          artist: 'Nina Žižić',
          id: 24,
          code: 'me',
        },
        {
          country: 'Lettland',
          song: 'Bur man laimi',
          artist: 'Tautumeitas',
          id: 25,
          code: 'lv',
        },
        {
          country: 'Albanien',
          song: 'Zjerm',
          artist: 'Shkodra Elektronike',
          id: 26,
          code: 'al',
        },
        {
          country: 'Portugal',
          song: 'Deslocado',
          artist: 'Napa',
          id: 27,
          code: 'pt',
        },
        {
          country: 'Polen',
          song: 'Gaja',
          artist: 'Justyna Steczkowska',
          id: 28,
          code: 'pl',
        },
        {
          country: 'Azerbajdzjan',
          song: 'Run with U',
          artist: 'Mamagama',
          id: 29,
          code: 'az',
        },
        {
          country: 'Ukraina',
          song: 'Bird of Pray',
          artist: 'Ziferblat',
          id: 30,
          code: 'ua',
        },
        {
          country: 'Georgien',
          song: 'Freedom',
          artist: 'Mariam Shengelia',
          id: 31,
          code: 'ge',
        },
        {
          country: 'Island',
          song: 'Róa',
          artist: 'Væb',
          id: 32,
          code: 'is',
        },
        {
          country: 'Estland',
          song: 'Espresso Macchiato',
          artist: 'Tommy Cash',
          id: 33,
          code: 'ee',
        },
        {
          country: 'Kroatien',
          song: 'Poison Cake',
          artist: 'Marko Bošnjak',
          id: 34,
          code: 'hr',
        },
        {
          country: 'Australien',
          song: 'Milkshake Man',
          artist: 'Go-Jo',
          id: 35,
          code: 'au',
        },
        {
          country: 'Tjeckien',
          song: 'Kiss Kiss Goodbye',
          artist: 'Adonxs',
          id: 36,
          code: 'cz',
        },
        {
          country: 'Malta',
          song: 'Serving',
          artist: 'Miriana Conte',
          id: 37,
          code: 'mt',
        },
      ];

      let blueprint = null;
      let betBlueprint = null;
      let resultBlueprint = null;
      let userBlueprint = null;
      let numberBlueprint = null;
      let pointsBlueprint = null;
      let leaderboardUserBlueprint = null;
      const createEntry = (entry, result, users) => {
        const resultClone = resultBlueprint.cloneNode(true);
        resultClone.id = entry.country + '_result';
        resultClone.classList.remove('hidden');
        resultClone.textContent = result;
        document.getElementById('bets').appendChild(resultClone);

        const clone = blueprint.cloneNode(true);
        clone.classList.add(`bg-[url(https://flagcdn.com/h60/${entry.code}.png)]`);
        clone.id = entry.country;
        clone.classList.remove('hidden');
        document.getElementById('bets').appendChild(clone);

        for (const user of users) {
          const place = user.bets.findIndex((b) => b.id === entry.id);
          const betClone = betBlueprint.cloneNode(true);
          betClone.id = user.name + '_' + entry.country;
          betClone.classList.remove('hidden');
          betClone.textContent = place + 1 + ` (${user.bets[place].points})`;
          document.getElementById('bets').appendChild(betClone);
        }
      };
      const createEntries = (entries, users) => {
        blueprint = document.getElementById('blueprint');
        betBlueprint = document.getElementById('betBlueprint');
        resultBlueprint = document.getElementById('resultBlueprint');
        userBlueprint = document.getElementById('userBlueprint');
        numberBlueprint = document.getElementById('numberBlueprint');
        pointsBlueprint = document.getElementById('pointsBlueprint');
        leaderboardUserBlueprint = document.getElementById('leaderboardUserBlueprint');
        document.getElementById('bets').classList.add(`grid-cols-[40px,95px,repeat(${users.length},minmax(auto,1fr))]`);
        users.map((user, index) => {
          const userClone = userBlueprint.cloneNode(true);
          userClone.id = user.name;
          userClone.classList.remove('hidden');
          userClone.textContent = user.name + ` (${user.points})`;
          document.getElementById('bets').appendChild(userClone);

          {
            const numberClone = numberBlueprint.cloneNode(true);
            numberClone.id = 'lead_' + index;
            numberClone.classList.remove('hidden');
            numberClone.textContent = index + 1;
            document.getElementById('leaderboard').appendChild(numberClone);
            const pointsClone = pointsBlueprint.cloneNode(true);
            pointsClone.id = 'lead_points_' + index;
            pointsClone.classList.remove('hidden');
            pointsClone.textContent = user.points;
            document.getElementById('leaderboard').appendChild(pointsClone);
            const userClone = leaderboardUserBlueprint.cloneNode(true);
            userClone.id = 'lead_' + user.name;
            userClone.classList.remove('hidden');
            userClone.textContent = user.name;
            document.getElementById('leaderboard').appendChild(userClone);
          }
        });
        entries.map((e, index) => createEntry(e, index + 1, users));
      };
      const isSubmissionLocked = new Date() > new Date('2025-05-17T19:00:00Z');
      (function () {
        if (!isSubmissionLocked) {
          window.location.href = location.href.replace('/result', '');
          return;
        }
        if (location.href.startsWith('file:///')) {
          setTimeout(() => {
            createEntries(entries, [
              {
                name: 'Alice Jonsson',
                points: Math.floor(100 * Math.random()),
                bets: entries.map((e) => ({ id: e.id, points: Math.floor(100 * Math.random()) })),
              },
              {
                name: 'Alice Jonsson 2',
                points: Math.floor(100 * Math.random()),
                bets: entries.map((e) => ({ id: e.id, points: Math.floor(100 * Math.random()) })),
              },
            ]);
            document.getElementById('main').classList.remove('hidden');
            document.getElementById('spinner').classList.add('hidden');
          }, 50);
        } else {
          fetch('/api/results')
            .then((r) => r.json())
            .then((data) => {
              document.getElementById('main').classList.remove('hidden');
              // {
              //     users: {name: string, points: number, bets: {id: number, points: number}[]}[],
              //     entries: number[]
              // }
              createEntries(
                data.entries.map((id) => entries.find((e) => e.id === id)),
                data.users
              );
            })
            .catch(console.error)
            .finally(() => {
              document.getElementById('spinner').classList.add('hidden');
            });
        }
      })();
    </script>
  </head>
  <body>
    <header class="flex flex-row justify-center mt-8">
      <h1 class="text-3xl font-bold">Uppsalakontorets Eurovisiontippning</h1>
    </header>
    <article class="flex flex-row justify-center mt-8 hidden" id="tokenGone">
      <div class="flex flex-col items-center">
        <h2 class="text-2xl">Din token är borta :(</h2>
        <p>Gå in på länken i din kalenderinbjudan för att förnya den.</p>
      </div>
    </article>
    <article class="flex lg:flex-row flex-col justify-center mt-8 hidden" id="main">
      <div class="grid flex-grow text-white relative p-4 gap-y-px" id="bets">
        <div class="flex flex-col justify-center text-center bg-main">#</div>
        <div class="flex flex-col justify-center text-center bg-main">Land</div>
        <div class="flex flex-col justify-center text-center bg-main hidden" id="userBlueprint"></div>
        <div
          class="h-[60px] hidden bg-main flex flex-col justify-center text-center hidden text-3xl"
          id="resultBlueprint"
        ></div>
        <div class="h-[60px] w-full bg-no-repeat bg-center bg-cover hidden" id="blueprint"></div>
        <div
          class="h-[60px] hidden bg-main flex flex-col justify-center text-center hidden text-3xl"
          id="betBlueprint"
        ></div>
      </div>
      <div class="grid grid-cols-[10%,20%,70%] h-full flex-grow text-white relative p-4 gap-y-px" id="leaderboard">
        <div class="flex flex-col justify-center text-center bg-main">#</div>
        <div class="flex flex-col justify-center text-center bg-main">Poäng</div>
        <div class="flex flex-col justify-center text-center bg-main">Namn</div>
        <div class="flex flex-col justify-center text-center bg-main hidden" id="numberBlueprint"></div>
        <div class="flex flex-col justify-center text-center bg-main hidden" id="pointsBlueprint"></div>
        <div class="flex flex-col justify-center text-center bg-main hidden" id="leaderboardUserBlueprint"></div>
      </div>
    </article>
    <div
      id="spinner"
      class="mx-auto mt-4 size-8 rounded-full border-4 border-black border-l-transparent animate-spin"
    ></div>
  </body>
</html>
