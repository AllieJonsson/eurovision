<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              main: '#111827',
              gold: '#d4af37',
              silver: '#c0c0c0',
              bronze: '#ff5733',
            },
          },
        },
      };
    </script>
    <script>
      const entries = [
        {
          country: 'Sverige',
          song: 'Bara bada bastu',
          artist: 'KAJ',
          id: 1,
          code: 'se',
        },
        {
          country: 'Israel',
          song: 'New Day Will Rise',
          artist: 'Yuval Raphael',
          id: 2,
          code: 'il',
        },
        {
          country: 'Nederländerna',
          song: 'C’est la vie',
          artist: 'Claude',
          id: 3,
          code: 'nl',
        },
        {
          country: 'San Marino',
          song: 'Tutta l’Italia',
          artist: 'Gabry Ponte',
          id: 4,
          code: 'sm',
        },
        {
          country: 'Spanien',
          song: 'Esa diva',
          artist: 'Melody',
          id: 5,
          code: 'es',
        },
        // {
        //   country: 'Slovenien',
        //   song: 'How Much Time Do We Have Left',
        //   artist: 'Klemen',
        //   id: 6,
        //   code: 'si',
        // },
        {
          country: 'Tyskland',
          song: 'Baller',
          artist: 'Abor & Tynna',
          id: 7,
          code: 'de',
        },
        {
          country: 'Luxemburg',
          song: 'La poupée monte le son',
          artist: 'Laura Thorn',
          id: 8,
          code: 'lu',
        },
        {
          country: 'Storbritannien',
          song: 'What The Hell Just Happened?',
          artist: 'Remember Monday',
          id: 9,
          code: 'gb',
        },
        {
          country: 'Frankrike',
          song: 'Maman',
          artist: 'Louane',
          id: 10,
          code: 'fr',
        },
        // {
        //   country: 'Cypern',
        //   song: 'Shh',
        //   artist: 'Theo Evan',
        //   id: 11,
        //   code: 'cy',
        // },
        {
          country: 'Armenien',
          song: 'Survivor',
          artist: 'Parg',
          id: 12,
          code: 'am',
        },
        // {
        //   country: 'Serbien',
        //   song: 'Mila',
        //   artist: 'Princ',
        //   id: 13,
        //   code: 'rs',
        // },
        {
          country: 'Norge',
          song: 'Lighter',
          artist: 'Kyle Alessandro',
          id: 14,
          code: 'no',
        },
        {
          country: 'Schweiz',
          song: 'Voyage',
          artist: 'Zoë Më',
          id: 15,
          code: 'ch',
        },
        {
          country: 'Österrike',
          song: 'Wasted Love',
          artist: 'JJ',
          id: 16,
          code: 'at',
        },
        // {
        //   country: 'Irland',
        //   song: 'Laika Party',
        //   artist: 'Emmy',
        //   id: 17,
        //   code: 'ie',
        // },
        {
          country: 'Litauen',
          song: 'Tavo akys',
          artist: 'Katarsis',
          id: 18,
          code: 'lt',
        },
        {
          country: 'Grekland',
          song: 'Asteromáta',
          artist: 'Klavdia',
          id: 19,
          code: 'gr',
        },
        {
          country: 'Danmark',
          song: 'Hallucination',
          artist: 'Sissal',
          id: 20,
          code: 'dk',
        },
        {
          country: 'Italien',
          song: 'Volevo essere un duro',
          artist: 'Lucio Corsi',
          id: 21,
          code: 'it',
        },
        {
          country: 'Finland',
          song: 'Ich komme',
          artist: 'Erika Vikman',
          id: 22,
          code: 'fi',
        },
        // {
        //   country: 'Belgien',
        //   song: 'Strobe Lights',
        //   artist: 'Red Sebastian',
        //   id: 23,
        //   code: 'be',
        // },
        // {
        //   country: 'Montenegro',
        //   song: 'Dobrodošli',
        //   artist: 'Nina Žižić',
        //   id: 24,
        //   code: 'me',
        // },
        {
          country: 'Lettland',
          song: 'Bur man laimi',
          artist: 'Tautumeitas',
          id: 25,
          code: 'lv',
        },
        {
          country: 'Albanien',
          song: 'Zjerm',
          artist: 'Shkodra Elektronike',
          id: 26,
          code: 'al',
        },
        {
          country: 'Portugal',
          song: 'Deslocado',
          artist: 'Napa',
          id: 27,
          code: 'pt',
        },
        {
          country: 'Polen',
          song: 'Gaja',
          artist: 'Justyna Steczkowska',
          id: 28,
          code: 'pl',
        },
        // {
        //   country: 'Azerbajdzjan',
        //   song: 'Run with U',
        //   artist: 'Mamagama',
        //   id: 29,
        //   code: 'az',
        // },
        {
          country: 'Ukraina',
          song: 'Bird of Pray',
          artist: 'Ziferblat',
          id: 30,
          code: 'ua',
        },
        // {
        //   country: 'Georgien',
        //   song: 'Freedom',
        //   artist: 'Mariam Shengelia',
        //   id: 31,
        //   code: 'ge',
        // },
        {
          country: 'Island',
          song: 'Róa',
          artist: 'Væb',
          id: 32,
          code: 'is',
        },
        {
          country: 'Estland',
          song: 'Espresso Macchiato',
          artist: 'Tommy Cash',
          id: 33,
          code: 'ee',
        },
        // {
        //   country: 'Kroatien',
        //   song: 'Poison Cake',
        //   artist: 'Marko Bošnjak',
        //   id: 34,
        //   code: 'hr',
        // },
        // {
        //   country: 'Australien',
        //   song: 'Milkshake Man',
        //   artist: 'Go-Jo',
        //   id: 35,
        //   code: 'au',
        // },
        // {
        //   country: 'Tjeckien',
        //   song: 'Kiss Kiss Goodbye',
        //   artist: 'Adonxs',
        //   id: 36,
        //   code: 'cz',
        // },
        {
          country: 'Malta',
          song: 'Serving',
          artist: 'Miriana Conte',
          id: 37,
          code: 'mt',
        },
      ];

      let blueprint = null;
      let betBlueprint = null;
      let resultBlueprint = null;
      let userBlueprint = null;
      let numberBlueprint = null;
      let pointsBlueprint = null;
      let leaderboardUserBlueprint = null;
      let areResultsIn = false;
      const createEntry = (entry, result, users) => {
        const resultClone = resultBlueprint.cloneNode(true);
        resultClone.id = entry.country + '_result';
        resultClone.classList.remove('hidden');
        resultClone.textContent = result;
        document.getElementById('bets').appendChild(resultClone);

        const clone = blueprint.cloneNode(true);
        if (areResultsIn) {
          clone.classList.add(`bg-[url(https://flagcdn.com/h60/${entry.code}.png)]`);
        } else {
          clone.classList.add('bg-main');
        }
        clone.id = entry.country;
        clone.classList.remove('hidden');
        document.getElementById('bets').appendChild(clone);

        for (const user of users) {
          const bet = user.bets[result - 1];
          const betClone = betBlueprint.cloneNode(true);
          betClone.id = user.name + '_' + result;
          betClone.classList.remove('hidden');
          const placeElem = document.createElement('span');
          placeElem.className = `bg-[url(https://flagcdn.com/h60/${
            entries.find((e) => e.id === bet.id).code
          }.png)] h-[60px] w-[95px] bg-no-repeat bg-center bg-cover `;
          betClone.appendChild(placeElem);
          if (areResultsIn) {
            const pointsElem = document.createElement('span');
            pointsElem.classList.add('text-lg');
            pointsElem.classList.add('w-[50px]');
            pointsElem.textContent = ` ${bet.points > 0 ? '+' : ''}${bet.points}`;
            betClone.appendChild(pointsElem);
          }
          document.getElementById('bets').appendChild(betClone);
        }
      };
      const createEntries = (entries, users) => {
        blueprint = document.getElementById('blueprint');
        betBlueprint = document.getElementById('betBlueprint');
        resultBlueprint = document.getElementById('resultBlueprint');
        userBlueprint = document.getElementById('userBlueprint');
        numberBlueprint = document.getElementById('numberBlueprint');
        pointsBlueprint = document.getElementById('pointsBlueprint');
        leaderboardUserBlueprint = document.getElementById('leaderboardUserBlueprint');
        document.getElementById('bets').classList.add(`grid-cols-[40px,95px,repeat(${users.length},minmax(auto,1fr))]`);
        users.map((user, index) => {
          const userClone = userBlueprint.cloneNode(true);
          userClone.id = user.name;
          userClone.classList.remove('hidden');
          userClone.textContent = user.name + ` (${user.points})`;
          document.getElementById('bets').appendChild(userClone);

          if (areResultsIn) {
            document.getElementById('leaderboard').classList.remove('hidden');
            const numberClone = numberBlueprint.cloneNode(true);
            numberClone.id = 'lead_' + index;
            numberClone.classList.remove('hidden');
            if (index < 3) {
              numberClone.classList.add(index === 0 ? 'h-[60px]' : index === 1 ? 'h-[50px]' : 'h-[40px]');
              numberClone.classList.add(index === 0 ? 'text-3xl' : index === 1 ? 'text-2xl' : 'text-xl');
              numberClone.classList.add(index === 0 ? 'text-gold' : index === 1 ? 'text-silver' : 'text-bronze');
            }
            numberClone.textContent = index + 1;
            document.getElementById('leaderboard').appendChild(numberClone);

            const pointsClone = pointsBlueprint.cloneNode(true);
            pointsClone.id = 'lead_points_' + index;
            pointsClone.classList.remove('hidden');
            if (index < 3) {
              pointsClone.classList.add(index === 0 ? 'h-[60px]' : index === 1 ? 'h-[50px]' : 'h-[40px]');
              pointsClone.classList.add(index === 0 ? 'text-3xl' : index === 1 ? 'text-2xl' : 'text-xl');
              pointsClone.classList.add(index === 0 ? 'text-gold' : index === 1 ? 'text-silver' : 'text-bronze');
            }
            pointsClone.textContent = user.points;

            document.getElementById('leaderboard').appendChild(pointsClone);
            const userClone = leaderboardUserBlueprint.cloneNode(true);
            userClone.id = 'lead_' + user.name;
            userClone.classList.remove('hidden');
            userClone.textContent = user.name;
            if (index < 3) {
              userClone.classList.add(index === 0 ? 'h-[60px]' : index === 1 ? 'h-[50px]' : 'h-[40px]');
              userClone.classList.add(index === 0 ? 'text-3xl' : index === 1 ? 'text-2xl' : 'text-xl');
              userClone.classList.add(index === 0 ? 'text-gold' : index === 1 ? 'text-silver' : 'text-bronze');
            }
            document.getElementById('leaderboard').appendChild(userClone);
          }
        });
        entries.map((e, index) => createEntry(e, index + 1, users));
      };
      const mean = (values) => {
        let sum = 0;
        for (const v of values) {
          sum += v;
        }
        return sum / values.length;
      };
      const isSubmissionLocked = new Date() > new Date('2025-05-17T21:00:00Z');
      const main = () => {
        if (!isSubmissionLocked) {
          window.location.href = location.href.replace('/result', '');
          return;
        }
        if (location.href.startsWith('file:///')) {
          const users = [
            {
              name: 'Alice Jonsson',
              points: 0,
              bets: entries.map((e) => ({ id: e.id, points: 0 })).sort(() => Math.random() * 2 - 1),
            },
            {
              name: 'Alice Jonsson 2',
              points: 0,
              bets: entries.map((e) => ({ id: e.id, points: 0 })).sort(() => Math.random() * 2 - 1),
            },
          ];
          createEntries(
            entries.sort(
              (a, b) =>
                mean(users.map((u) => u.bets.findIndex((bet) => bet.id === a.id))) -
                mean(users.map((u) => u.bets.findIndex((bet) => bet.id === b.id)))
            ),
            users
          );
          document.getElementById('main').classList.remove('hidden');
          document.getElementById('username').classList.remove('hidden');
          document.getElementById('spinner').classList.add('hidden');
        } else {
          fetch('/api/results')
            .then((r) => r.json())
            .then((data) => {
              document.getElementById('main').classList.remove('hidden');
              document.getElementById('username').classList.remove('hidden');
              document.getElementById('username').textContent = `Hej ${data.user}!`;
              if (data.entries.length > 0) areResultsIn = true;
              if (!areResultsIn) {
                document.getElementById('waitingForResults').classList.remove('hidden');
              }
              const a = [];
              createEntries(
                areResultsIn
                  ? data.entries.map((id) => entries.find((e) => e.id === id))
                  : entries.sort(
                      (a, b) =>
                        mean(data.users.map((u) => u.bets.findIndex((bet) => bet.id === b.id))) -
                        mean(data.users.map((u) => u.bets.findIndex((bet) => bet.id === a.id)))
                    ),
                data.users
              );
            })
            .catch(console.error)
            .finally(() => {
              document.getElementById('spinner').classList.add('hidden');
            });
        }
      };

      (function () {
        addEventListener('DOMContentLoaded', main);
      })();
    </script>
  </head>
  <body>
    <header class="flex flex-col items-center justify-center mt-8">
      <h1 class="text-3xl font-bold text-center">
        Uppsalakontorets Eurovision<span class="line-through text-xl">tippning</span>gissning
      </h1>
      <h2 class="text-2xl font-bold hidden my-4 text-center" id="username">Hej Alice!</h2>
    </header>
    <article class="flex flex-row justify-center mt-8 hidden" id="tokenGone">
      <div class="flex flex-col items-center">
        <h2 class="text-2xl">Din token är borta :(</h2>
        <p>Gå in på länken i din kalenderinbjudan för att förnya den.</p>
      </div>
    </article>
    <article class="hidden mt-4 text-xl flex flex-col items-center justify-center" id="waitingForResults">
      Vi väntar på resultatet, spännande!
    </article>
    <article class="flex lg:flex-row flex-col justify-center mt-4" id="main">
      <div
        class="grid grid-cols-[10%,20%,70%] h-full flex-grow text-white relative p-4 gap-y-px hidden"
        id="leaderboard"
      >
        <div class="flex flex-col justify-center text-center bg-main">#</div>
        <div class="flex flex-col justify-center text-center bg-main">Poäng</div>
        <div class="flex flex-col justify-center text-center bg-main">Namn</div>
        <div class="flex flex-col justify-center text-center bg-main hidden" id="numberBlueprint"></div>
        <div class="flex flex-col justify-center text-center bg-main hidden" id="pointsBlueprint"></div>
        <div class="flex flex-col justify-center text-center bg-main hidden" id="leaderboardUserBlueprint"></div>
      </div>
      <div class="grid flex-grow text-white relative p-4 gap-y-px" id="bets">
        <div class="flex flex-col justify-center text-center bg-main">#</div>
        <div class="flex flex-col justify-center text-center bg-main">Vinnare</div>
        <div class="flex flex-col justify-center text-center bg-main hidden" id="userBlueprint"></div>
        <div
          class="h-[60px] hidden bg-main flex flex-col justify-center text-center hidden text-3xl"
          id="resultBlueprint"
        ></div>
        <div class="h-[60px] w-full bg-no-repeat bg-center bg-cover hidden" id="blueprint"></div>
        <div
          class="h-[60px] hidden bg-main flex flex-row justify-center items-center gap-2 hidden text-3xl"
          id="betBlueprint"
        ></div>
      </div>
    </article>
    <div
      id="spinner"
      class="mx-auto mt-4 size-8 rounded-full border-4 border-black border-l-transparent animate-spin"
    ></div>
  </body>
</html>
