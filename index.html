<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              main: '#111827',
            },
          },
        },
      };
    </script>
    <script>
      const entries = [
        {
          country: 'Sverige',
          song: 'Bara bada bastu',
          artist: 'KAJ',
          id: 1,
          code: 'se',
        },
        {
          country: 'Israel',
          song: 'New Day Will Rise',
          artist: 'Yuval Raphael',
          id: 2,
          code: 'il',
        },
        {
          country: 'Nederländerna',
          song: 'C’est la vie',
          artist: 'Claude',
          id: 3,
          code: 'nl',
        },
        {
          country: 'San Marino',
          song: 'Tutta l’Italia',
          artist: 'Gabry Ponte',
          id: 4,
          code: 'sm',
        },
        {
          country: 'Spanien',
          song: 'Esa diva',
          artist: 'Melody',
          id: 5,
          code: 'es',
        },
        {
          country: 'Slovenien',
          song: 'How Much Time Do We Have Left',
          artist: 'Klemen',
          id: 6,
          code: 'si',
        },
        {
          country: 'Tyskland',
          song: 'Baller',
          artist: 'Abor & Tynna',
          id: 7,
          code: 'de',
        },
        {
          country: 'Luxemburg',
          song: 'La poupée monte le son',
          artist: 'Laura Thorn',
          id: 8,
          code: 'lu',
        },
        {
          country: 'Storbritannien',
          song: 'What The Hell Just Happened?',
          artist: 'Remember Monday',
          id: 9,
          code: 'gb',
        },
        {
          country: 'Frankrike',
          song: 'Maman',
          artist: 'Louane',
          id: 10,
          code: 'fr',
        },
        {
          country: 'Cypern',
          song: 'Shh',
          artist: 'Theo Evan',
          id: 11,
          code: 'cy',
        },
        {
          country: 'Armenien',
          song: 'Survivor',
          artist: 'Parg',
          id: 12,
          code: 'am',
        },
        {
          country: 'Serbien',
          song: 'Mila',
          artist: 'Princ',
          id: 13,
          code: 'rs',
        },
        {
          country: 'Norge',
          song: 'Lighter',
          artist: 'Kyle Alessandro',
          id: 14,
          code: 'no',
        },
        {
          country: 'Schweiz',
          song: 'Voyage',
          artist: 'Zoë Më',
          id: 15,
          code: 'ch',
        },
        {
          country: 'Österrike',
          song: 'Wasted Love',
          artist: 'JJ',
          id: 16,
          code: 'at',
        },
        {
          country: 'Irland',
          song: 'Laika Party',
          artist: 'Emmy',
          id: 17,
          code: 'ie',
        },
        {
          country: 'Litauen',
          song: 'Tavo akys',
          artist: 'Katarsis',
          id: 18,
          code: 'lt',
        },
        {
          country: 'Grekland',
          song: 'Asteromáta',
          artist: 'Klavdia',
          id: 19,
          code: 'gr',
        },
        {
          country: 'Danmark',
          song: 'Hallucination',
          artist: 'Sissal',
          id: 20,
          code: 'dk',
        },
        {
          country: 'Italien',
          song: 'Volevo essere un duro',
          artist: 'Lucio Corsi',
          id: 21,
          code: 'it',
        },
        {
          country: 'Finland',
          song: 'Ich komme',
          artist: 'Erika Vikman',
          id: 22,
          code: 'fi',
        },
        {
          country: 'Belgien',
          song: 'Strobe Lights',
          artist: 'Red Sebastian',
          id: 23,
          code: 'be',
        },
        {
          country: 'Montenegro',
          song: 'Dobrodošli',
          artist: 'Nina Žižić',
          id: 24,
          code: 'me',
        },
        {
          country: 'Lettland',
          song: 'Bur man laimi',
          artist: 'Tautumeitas',
          id: 25,
          code: 'lv',
        },
        {
          country: 'Albanien',
          song: 'Zjerm',
          artist: 'Shkodra Elektronike',
          id: 26,
          code: 'al',
        },
        {
          country: 'Portugal',
          song: 'Deslocado',
          artist: 'Napa',
          id: 27,
          code: 'pt',
        },
        {
          country: 'Polen',
          song: 'Gaja',
          artist: 'Justyna Steczkowska',
          id: 28,
          code: 'pl',
        },
        {
          country: 'Azerbajdzjan',
          song: 'Run with U',
          artist: 'Mamagama',
          id: 29,
          code: 'az',
        },
        {
          country: 'Ukraina',
          song: 'Bird of Pray',
          artist: 'Ziferblat',
          id: 30,
          code: 'ua',
        },
        {
          country: 'Georgien',
          song: 'Freedom',
          artist: 'Mariam Shengelia',
          id: 31,
          code: 'ge',
        },
        {
          country: 'Island',
          song: 'Róa',
          artist: 'Væb',
          id: 32,
          code: 'is',
        },
        {
          country: 'Estland',
          song: 'Espresso Macchiato',
          artist: 'Tommy Cash',
          id: 33,
          code: 'ee',
        },
        {
          country: 'Kroatien',
          song: 'Poison Cake',
          artist: 'Marko Bošnjak',
          id: 34,
          code: 'hr',
        },
        {
          country: 'Australien',
          song: 'Milkshake Man',
          artist: 'Go-Jo',
          id: 35,
          code: 'au',
        },
        {
          country: 'Tjeckien',
          song: 'Kiss Kiss Goodbye',
          artist: 'Adonxs',
          id: 36,
          code: 'cz',
        },
        {
          country: 'Malta',
          song: 'Serving',
          artist: 'Miriana Conte',
          id: 37,
          code: 'mt',
        },
      ];
      let currentDragId = null;
      let currentMoveX,
        currentMoveY = 0;
      let blueprint = null;
      let myOrder = [];
      const getItem = () => {
        const index = Math.min(Math.max(0, Math.floor((currentMoveY + 30) / 60)), myOrder.length - 1);
        const item = document.getElementById(myOrder.filter((m) => m.country !== currentDragId)[index].country);
        return [index, item];
      };
      const followMouse = (e) => {
        if (currentDragId === null) return;
        currentMoveX += e.movementX;
        currentMoveY += e.movementY;
        const currentDrag = document.getElementById(currentDragId);
        currentDrag.style.transform = `translate(${currentMoveX}px, ${currentMoveY}px)`;
        const listItem = document.getElementById('list');
        const [index, item] = getItem();
        item.insertAdjacentElement(index > listItem.childElementCount - 1 ? 'afterend' : 'beforebegin', blueprint);
      };
      const createEntry = (entry) => {
        const clone = blueprint.cloneNode(true);
        clone.firstChild.parentElement.firstElementChild.classList.add(
          `bg-[url(https://flagcdn.com/h60/${entry.code}.png)]`
        );
        clone.firstChild.parentElement.lastElementChild.textContent = entry.artist + ' - ' + entry.song;
        clone.id = entry.country;
        clone.classList.remove('hidden');

        const node = document.getElementById('list').appendChild(clone);
        node.addEventListener('pointerdown', (e) => {
          e.preventDefault();
          currentDragId = e.currentTarget.id;
          currentMoveX = 0;
          currentMoveY = e.currentTarget.offsetTop;
          blueprint.classList.remove('hidden');
          blueprint.classList.add('invisible');
          e.currentTarget.classList.add('absolute');

          followMouse({ movementX: 0, movementY: 0 });
        });
      };
      const createEntries = (entries) => {
        myOrder = structuredClone(entries);
        blueprint = document.getElementById('blueprint');
        entries.map(createEntry);
        window.addEventListener('pointermove', followMouse);
        window.addEventListener('pointerup', (e) => {
          if (currentDragId === null) return;
          e.preventDefault();
          blueprint.classList.add('hidden');
          blueprint.classList.remove('invisible');
          const drag = document.getElementById(currentDragId);
          drag.classList.remove('absolute');
          drag.style.transform = '';
          const listItem = document.getElementById('list');
          const [index, item] = getItem();
          item.insertAdjacentElement(index > listItem.childElementCount - 1 ? 'afterend' : 'beforebegin', drag);
          const elem = myOrder.find((m) => m.country === currentDragId);
          const prevIndex = myOrder.indexOf(elem);
          myOrder.splice(prevIndex, 1);
          myOrder = [...myOrder.slice(0, index), elem, ...myOrder.slice(index)];
          if (!location.href.startsWith('file:///')) {
            const id = localStorage.getItem('id');
            if (!id) {
              document.getElementById('tokenGone').classList.remove('hidden');
              document.getElementById('main').classList.add('hidden');
              return;
            }
            fetch('/api/bet', {
              method: 'POST',
              body: JSON.stringify({ id, bet: myOrder.map((m) => m.id) }),
            });
          }
          currentDragId = null;
        });
      };
      (function () {
        const id = new URL(location.href).searchParams.get('id') ?? localStorage.getItem('id');
        if (!id) {
          document.getElementById('tokenGone').classList.remove('hidden');
          document.getElementById('spinner').classList.add('hidden');
        } else {
          localStorage.setItem('id', id);
          history.pushState(null, '', location.pathname);
          if (location.href.startsWith('file:///')) {
            setTimeout(() => {
              createEntries(entries);
              document.getElementById('main').classList.remove('hidden');
              document.getElementById('spinner').classList.add('hidden');
            }, 50);
          } else {
            fetch('/api/bet?id=' + id)
              .then((r) => r.json())
              .then((data) => {
                document.getElementById('main').classList.remove('hidden');
                createEntries(data.bet.map((id) => entries.find((e) => e.id === id)));
              })
              .catch(console.error)
              .finally(() => {
                document.getElementById('spinner').classList.add('hidden');
              });
          }
        }
      })();
    </script>
  </head>
  <body>
    <header class="flex flex-row justify-center mt-8">
      <h1 class="text-3xl font-bold">Uppsalakontorets Eurovisiontippning</h1>
    </header>
    <article class="flex flex-row justify-center mt-8 hidden" id="tokenGone">
      <div class="flex flex-col items-center">
        <h2 class="text-2xl">Din token är borta :(</h2>
        <p>Gå in på länken i din kalenderinbjudan för att förnya den.</p>
      </div>
    </article>
    <article class="flex flex-row justify-center mt-8 hidden" id="main">
      <div class="flex flex-col items-center flex-grow text-white relative" id="list">
        <div class="h-[60px] w-[80%] flex flex-row border-b-4 border-white hidden" id="blueprint">
          <div class="w-[95px] h-full bg-no-repeat bg-center bg-cover"></div>
          <div class="flex flex-grow bg-main text-2xl font-bold items-center p-4"></div>
        </div>
      </div>
    </article>
    <div
      id="spinner"
      class="mx-auto mt-4 size-8 rounded-full border-4 border-black border-l-transparent animate-spin"
    ></div>
  </body>
</html>
