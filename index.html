<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              main: '#111827',
            },
          },
        },
      };
    </script>
    <script>
      const entries = [
        {
          country: 'Sverige',
          song: 'Bara bada bastu',
          artist: 'KAJ',
          id: 1,
          code: 'se',
        },
        {
          country: 'Israel',
          song: 'New Day Will Rise',
          artist: 'Yuval Raphael',
          id: 2,
          code: 'il',
        },
        {
          country: 'Nederländerna',
          song: 'C’est la vie',
          artist: 'Claude',
          id: 3,
          code: 'nl',
        },
        {
          country: 'San Marino',
          song: 'Tutta l’Italia',
          artist: 'Gabry Ponte',
          id: 4,
          code: 'sm',
        },
        {
          country: 'Spanien',
          song: 'Esa diva',
          artist: 'Melody',
          id: 5,
          code: 'es',
        },
        {
          country: 'Slovenien',
          song: 'How Much Time Do We Have Left',
          artist: 'Klemen',
          id: 6,
          code: 'si',
        },
        {
          country: 'Tyskland',
          song: 'Baller',
          artist: 'Abor & Tynna',
          id: 7,
          code: 'de',
        },
        {
          country: 'Luxemburg',
          song: 'La poupée monte le son',
          artist: 'Laura Thorn',
          id: 8,
          code: 'lu',
        },
        {
          country: 'Storbritannien',
          song: 'What The Hell Just Happened?',
          artist: 'Remember Monday',
          id: 9,
          code: 'gb',
        },
        {
          country: 'Frankrike',
          song: 'Maman',
          artist: 'Louane',
          id: 10,
          code: 'fr',
        },
        {
          country: 'Cypern',
          song: 'Shh',
          artist: 'Theo Evan',
          id: 11,
          code: 'cy',
        },
        {
          country: 'Armenien',
          song: 'Survivor',
          artist: 'Parg',
          id: 12,
          code: 'am',
        },
        {
          country: 'Serbien',
          song: 'Mila',
          artist: 'Princ',
          id: 13,
          code: 'rs',
        },
        {
          country: 'Norge',
          song: 'Lighter',
          artist: 'Kyle Alessandro',
          id: 14,
          code: 'no',
        },
        {
          country: 'Schweiz',
          song: 'Voyage',
          artist: 'Zoë Më',
          id: 15,
          code: 'ch',
        },
        {
          country: 'Österrike',
          song: 'Wasted Love',
          artist: 'JJ',
          id: 16,
          code: 'at',
        },
        {
          country: 'Irland',
          song: 'Laika Party',
          artist: 'Emmy',
          id: 17,
          code: 'ie',
        },
        {
          country: 'Litauen',
          song: 'Tavo akys',
          artist: 'Katarsis',
          id: 18,
          code: 'lt',
        },
        {
          country: 'Grekland',
          song: 'Asteromáta',
          artist: 'Klavdia',
          id: 19,
          code: 'gr',
        },
        {
          country: 'Danmark',
          song: 'Hallucination',
          artist: 'Sissal',
          id: 20,
          code: 'dk',
        },
        {
          country: 'Italien',
          song: 'Volevo essere un duro',
          artist: 'Lucio Corsi',
          id: 21,
          code: 'it',
        },
        {
          country: 'Finland',
          song: 'Ich komme',
          artist: 'Erika Vikman',
          id: 22,
          code: 'fi',
        },
        {
          country: 'Belgien',
          song: 'Strobe Lights',
          artist: 'Red Sebastian',
          id: 23,
          code: 'be',
        },
        {
          country: 'Montenegro',
          song: 'Dobrodošli',
          artist: 'Nina Žižić',
          id: 24,
          code: 'me',
        },
        {
          country: 'Lettland',
          song: 'Bur man laimi',
          artist: 'Tautumeitas',
          id: 25,
          code: 'lv',
        },
        {
          country: 'Albanien',
          song: 'Zjerm',
          artist: 'Shkodra Elektronike',
          id: 26,
          code: 'al',
        },
        {
          country: 'Portugal',
          song: 'Deslocado',
          artist: 'Napa',
          id: 27,
          code: 'pt',
        },
        {
          country: 'Polen',
          song: 'Gaja',
          artist: 'Justyna Steczkowska',
          id: 28,
          code: 'pl',
        },
        {
          country: 'Azerbajdzjan',
          song: 'Run with U',
          artist: 'Mamagama',
          id: 29,
          code: 'az',
        },
        {
          country: 'Ukraina',
          song: 'Bird of Pray',
          artist: 'Ziferblat',
          id: 30,
          code: 'ua',
        },
        {
          country: 'Georgien',
          song: 'Freedom',
          artist: 'Mariam Shengelia',
          id: 31,
          code: 'ge',
        },
        {
          country: 'Island',
          song: 'Róa',
          artist: 'Væb',
          id: 32,
          code: 'is',
        },
        {
          country: 'Estland',
          song: 'Espresso Macchiato',
          artist: 'Tommy Cash',
          id: 33,
          code: 'ee',
        },
        {
          country: 'Kroatien',
          song: 'Poison Cake',
          artist: 'Marko Bošnjak',
          id: 34,
          code: 'hr',
        },
        {
          country: 'Australien',
          song: 'Milkshake Man',
          artist: 'Go-Jo',
          id: 35,
          code: 'au',
        },
        {
          country: 'Tjeckien',
          song: 'Kiss Kiss Goodbye',
          artist: 'Adonxs',
          id: 36,
          code: 'cz',
        },
        {
          country: 'Malta',
          song: 'Serving',
          artist: 'Miriana Conte',
          id: 37,
          code: 'mt',
        },
      ];
      let currentDragId = null;
      let startY = 0;
      let currentMoveY = 0;
      let blueprint = null;
      let myOrder = [];
      const isSubmissionLocked = new Date() > new Date('2025-05-17T19:00:00Z');
      const getItem = () => {
        const index = Math.max(0, Math.floor((currentMoveY + 30) / 60));
        const item = document.getElementById(
          myOrder.filter((m) => m.country !== currentDragId)[Math.min(index, myOrder.length - 2)].country
        );
        return [index, item];
      };
      const followMouse = (e) => {
        if (currentDragId === null) return;
        currentMoveY = e.pageY - startY;
        const currentDrag = document.getElementById(currentDragId);
        currentDrag.style.transform = `translateY(${currentMoveY}px)`;
        const listItem = document.getElementById('list');
        const [index, item] = getItem();
        item.insertAdjacentElement(index >= listItem.childElementCount - 1 ? 'afterend' : 'beforebegin', blueprint);
      };
      const createEntry = (entry, index) => {
        const clone = blueprint.cloneNode(true);
        clone.firstChild.parentElement.firstElementChild.textContent = index + 1;
        clone.firstChild.parentElement.firstElementChild.nextElementSibling.classList.add(
          `bg-[url(https://flagcdn.com/h60/${entry.code}.png)]`
        );
        clone.firstChild.parentElement.lastElementChild.previousElementSibling.textContent =
          entry.artist + ' - ' + entry.song;
        clone.id = entry.country;
        clone.classList.remove('hidden');

        const node = document.getElementById('list').appendChild(clone);
        if (isSubmissionLocked) return;

        clone.firstChild.parentElement.lastElementChild.addEventListener('touchstart', (e) => {
          e.preventDefault();
          currentDragId = e.currentTarget.parentElement.id;
          startY = e.touches[0].pageY - e.currentTarget.parentElement.offsetTop;
          blueprint.classList.remove('hidden');
          blueprint.classList.add('invisible');
          e.currentTarget.parentElement.classList.add('absolute');

          console.log(e);
          followMouse(e.touches[0]);
        });
        node.addEventListener('mousedown', (e) => {
          e.preventDefault();
          currentDragId = e.currentTarget.id;
          startY = e.pageY - e.currentTarget.offsetTop;
          blueprint.classList.remove('hidden');
          blueprint.classList.add('invisible');
          e.currentTarget.classList.add('absolute');

          followMouse(e);
        });
      };
      const createEntries = (entries) => {
        myOrder = structuredClone(entries);
        blueprint = document.getElementById('blueprint');
        entries.map(createEntry);
        if (isSubmissionLocked) {
          document.getElementById('submissionLocked').classList.remove('hidden');
          return;
        }
        window.addEventListener('pointermove', followMouse);
        window.addEventListener('pointerup', (e) => {
          if (currentDragId === null) return;
          e.preventDefault();
          blueprint.classList.add('hidden');
          blueprint.classList.remove('invisible');
          const drag = document.getElementById(currentDragId);
          drag.classList.remove('absolute');
          drag.style.transform = '';
          const listItem = document.getElementById('list');
          const [index, item] = getItem();
          item.insertAdjacentElement(index >= listItem.childElementCount - 1 ? 'afterend' : 'beforebegin', drag);
          const elem = myOrder.find((m) => m.country === currentDragId);
          const prevIndex = myOrder.indexOf(elem);
          myOrder.splice(prevIndex, 1);
          myOrder =
            index >= myOrder.length ? [...myOrder, elem] : [...myOrder.slice(0, index), elem, ...myOrder.slice(index)];

          let rankIndex = 0;
          for (const child of listItem.children) {
            if (child.id !== 'blueprint') {
              rankIndex++;
              child.firstElementChild.textContent = rankIndex;
            }
          }
          if (!location.href.startsWith('file:///')) {
            const id = localStorage.getItem('id');
            if (!id) {
              document.getElementById('tokenGone').classList.remove('hidden');
              document.getElementById('main').classList.add('hidden');
              return;
            }
            fetch('/api/bet', {
              method: 'POST',
              body: JSON.stringify({ id, bet: myOrder.map((m) => m.id) }),
            });
          }
          currentDragId = null;
        });
      };
      const main = () => {
        const id = new URL(location.href).searchParams.get('id') ?? localStorage.getItem('id');
        if (!id) {
          document.getElementById('tokenGone').classList.remove('hidden');
          document.getElementById('spinner').classList.add('hidden');
        } else {
          localStorage.setItem('id', id);
          history.pushState(null, '', location.pathname);
          if (location.href.startsWith('file:///')) {
            createEntries(entries);
            document.getElementById('main').classList.remove('hidden');
            document.getElementById('username').classList.remove('hidden');
            document.getElementById('spinner').classList.add('hidden');
          } else {
            fetch('/api/bet?id=' + id)
              .then((r) => r.json())
              .then((data) => {
                document.getElementById('main').classList.remove('hidden');
                document.getElementById('username').classList.remove('hidden');
                document.getElementById("username").textContent = `Hej ${data.user}!`;
                if (data.bet.length === 0) {
                  createEntries(entries);
                  fetch('/api/bet', {
                    method: 'POST',
                    body: JSON.stringify({ id, bet: entries.map((m) => m.id) }),
                  });
                } else {
                  createEntries(data.bet.map((id) => entries.find((e) => e.id === id)));
                }
              })
              .catch(console.error)
              .finally(() => {
                document.getElementById('spinner').classList.add('hidden');
              });
          }
        }
      };
      (function () {
        addEventListener('DOMContentLoaded', main);
      })();
    </script>
  </head>
  <body>
    <header class="flex flex-col items-center justify-center mt-8">
      <h1 class="text-3xl font-bold">Uppsalakontorets Eurovision<span class="line-through text-xl">tippning</span>gissning</h1>
      <h2 class="text-2xl font-bold hidden my-4" id="username">Hej Alice!</h2>
    </header>
    <article class="flex flex-row justify-center mt-8 hidden" id="tokenGone">
      <div class="flex flex-col items-center">
        <h3 class="text-2xl">Aj då, nu tappades ditt id bort :(</h2>
        <p>Gå in på länken i din inbjudningsmejlet för att hämta din gissning.</p>
      </div>
    </article>
    <article class="flex flex-row justify-center mt-8 hidden" id="submissionLocked">
      <div class="flex flex-col items-center text-center">
        <h3 class="text-2xl">Gissningen är låst</h2>
        <p>Vem vinner? Kika in resultatsidan, spännande!</p>
        <a class="underline" href="/result">Gå till resultatsidan</a>
      </div>
    </article>
    <article class="flex flex-row justify-center mt-8 hidden" id="main">
      <div class="flex flex-col items-center flex-grow text-white relative" id="list">
        <div class="h-[60px] w-[98%] md:w-[80%] flex flex-row border-y-2 border-white hidden" id="blueprint">
          <div
            class="flex flex-col bg-main text-sm md:text-lg lg:text-2xl flex-shrink-0 justify-center text-center w-6 md:w-8 lg:w-10"
          >
            0
          </div>
          <div class="w-[95px] h-full bg-no-repeat bg-center bg-cover flex-shrink-0"></div>
          <div class="flex flex-grow bg-main text-sm md:text-lg lg:text-2xl font-bold items-center px-2 lg:p-4"></div>
          <div class="flex flex-col bg-main justify-between items-center w-8 pr-2 py-5 lg:hidden flex-shrink-0">
            <div class="border-b-2 border-white/60 w-full"></div>
            <div class="border-b-2 border-white/60 w-full"></div>
            <div class="border-b-2 border-white/60 w-full"></div>
          </div>
        </div>
      </div>
    </article>
    <div
      id="spinner"
      class="mx-auto mt-4 size-8 rounded-full border-4 border-black border-l-transparent animate-spin"
    ></div>
  </body>
</html>
